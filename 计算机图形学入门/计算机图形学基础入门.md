# 计算机图形学基础入门

## 2D图形的基本变换（2D Transformation）

### 图像的缩放(Scale)

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\非均匀缩放.png" style="zoom:50%;" />
$$
\begin{aligned}
x^,&=s_xx \\
y^,&=s_yy\\
\begin{bmatrix}
x^, \\
y^, \\
\end{bmatrix}
&=
\begin{bmatrix}
s_x & 0\\
0 & s_y\\
\end{bmatrix}
\begin{bmatrix}
z\\
y\\
\end{bmatrix}
\end{aligned}
$$

### 图像的对称(Reflection)

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\对称.png" style="zoom:50%;" />
$$
\begin{aligned}
x^,&=-x \\
y^,&=y\\
\begin{bmatrix}
x^, \\
y^, \\
\end{bmatrix}
&=
\begin{bmatrix}
-1 & 0\\
0 & 1\\
\end{bmatrix}
\begin{bmatrix}
z\\
y\\
\end{bmatrix}
\end{aligned}
$$

### 图像的切变(Shear)

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\图形的切片.png" style="zoom:50%;" />
$$
\begin{bmatrix}
x^, \\
y^, \\
\end{bmatrix}
=
\begin{bmatrix}
1 & a\\
0 & 1\\
\end{bmatrix}
\begin{bmatrix}
x\\
y\\
\end{bmatrix}
$$

### 图像的旋转(默认沿原点逆时针,Rotation)

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\图像的旋转.png" style="zoom:50%;" />
$$
R_\theta
=
\begin{bmatrix}
\cos\theta & -\sin\theta\\
\sin\theta & \cos\theta\\
\end{bmatrix}
$$
<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\旋转矩阵的推导.png" style="zoom:50%;" />

### 线性变换矩阵归纳

**标准形式：**
$$
\begin{bmatrix}
x^, \\
y^, \\
\end{bmatrix}
=
\begin{bmatrix}
a & b\\
c & d\\
\end{bmatrix}
\begin{bmatrix}
x\\
y\\
\end{bmatrix}
$$
**缩放：**
$$
\begin{bmatrix}
x^, \\
y^, \\
\end{bmatrix}
=
\begin{bmatrix}
s_x & 0\\
0 & s_y\\
\end{bmatrix}
\begin{bmatrix}
x\\
y\\
\end{bmatrix}
$$
**切变：**
$$
\begin{bmatrix}
x^, \\
y^, \\
\end{bmatrix}
=
\begin{bmatrix}
k & a/k\\
0 & k\\
\end{bmatrix}
\begin{bmatrix}
x\\
y\\
\end{bmatrix}
$$
**旋转：**
$$
\begin{bmatrix}
x^, \\
y^, \\
\end{bmatrix}
=
\begin{bmatrix}
\cos\theta & -\sin\theta\\
\sin\theta & \cos\theta\\
\end{bmatrix}
\begin{bmatrix}
x\\
y\\
\end{bmatrix}
$$

### 移动(Transilation)与齐次坐标

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\图像的移动.png" style="zoom:50%;" />
$$
\begin{bmatrix}
x^, \\
y^, \\
\end{bmatrix}
=
\begin{bmatrix}
a & b\\
c & d\\
\end{bmatrix}
\begin{bmatrix}
x\\
y\\
\end{bmatrix}
+
\begin{bmatrix}
t_x\\
t_y\\
\end{bmatrix}
$$
**图像的移动无法用线性变换归纳！但是我们可以这样解决：**
$$
\begin{bmatrix}
x^, \\
y^, \\
\omega^,\\
\end{bmatrix}
=
\begin{bmatrix}
a & b & t_x \\
c & d & t_y \\
0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}
x\\
y\\
1\\
\end{bmatrix}
=
\begin{bmatrix}
x+t_x\\
y+t_y\\
1\\
\end{bmatrix}
$$

$$
通常，我们知道：\\
\boxed{
1.矢量+矢量=矢量\\
2.点-点=矢量\\
3.点+矢量=点\\
4.点+点=？？
}\\
基于矩阵
\begin{bmatrix}
x\\
y\\
\omega\\
\end{bmatrix}在点相加后成为\begin{bmatrix}
x/\omega\\
y/\omega\\
1\\
\end{bmatrix}
(\omega\ne0)
$$

**所以点的相加得到的是两个点的终点！简单总结：**

**移动：**
$$
T_{s_x,s_y}
=
\begin{bmatrix}
1 & 0 & t_x \\
0 & 1 & t_y \\
0 & 0 & 1 \\
\end{bmatrix}
$$
**缩放：**
$$
s_{(s_x,s_y)}
=
\begin{bmatrix}
s_x & 0 & 0 \\
0 & s_y & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
$$
**旋转：**
$$
s_{\alpha}
=
\begin{bmatrix}
\cos\alpha & -\sin\alpha & 0 \\
\sin\alpha & \cos\alpha & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
$$

### 认识逆变换

**对任意M的变换存在逆变换M^-1^，在数理意义上，逆变换相当于乘于逆矩阵。**

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\逆变换.png)

### 变换的组合

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\变换的组合.png" style="zoom:50%;" />

**想要完成上面的变换，我们需要将变换拆解**

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\变换的组合1.png" style="zoom:50%;" />

**变换的顺序很重要！**

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\变换的组合2.png" style="zoom:50%;" />

**看来变换的处理不满足交换律。**
$$
R_k·T_{(s_x,s_y)}\ne T_{(s_x,s_y)}·R_k
$$
**但是矩阵满足结合律：**
$$
W_1·(W_2·W_3)=(W_1·W_2)·W_3
$$


**而对于齐次坐标而言：**
$$
\begin{aligned}
T_{1,0}·R_{45°}\begin{bmatrix}x\\y\\1\end{bmatrix}
&=
\begin{bmatrix}
1 & 0 & 1 \\
0 & 1 & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}
\cos k & -\sin k & 0 \\
\sin k & \cos k & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}x\\y\\1\end{bmatrix}\\
&=
\begin{bmatrix}
\cos k & -\sin k & 1 \\
\sin k & \cos k & 0 \\
0 & 0 & 1 \\
\end{bmatrix}
\begin{bmatrix}x\\y\\1\end{bmatrix}\\
\end{aligned}
$$
**变换顺序为==先线性变换，再仿射变换==**。

## PS:特殊的旋转

**对于旋转矩阵，它的逆矩阵就是它的转置矩阵**
$$
R_{-\theta}=R_{\theta}^{-1}
$$
**对于这种矩阵，数学上称为正交矩阵**

## 三维图形变换

**简单推广二维情况就可以知道三维情况下：**
$$
\begin{aligned}
3D point &=(x,y.z.1)^T\\
3D vector &=(x,y.z.0)^T
\end{aligned}
$$
**进而推断存在三维齐次坐标：**
$$
\begin{bmatrix}
x^,\\y^,\\z^,\\1
\end{bmatrix}
=
\begin{bmatrix}
a & b & c & t_x \\
d & e & f & t_y \\
g & h & i & t_z \\
0 & 0 & 0 & 1\\
\end{bmatrix}
·
\begin{bmatrix}
x\\y\\z\\1
\end{bmatrix}
$$

### 对三维基本变换的归纳

**缩放：**
$$
S_{(s_x,s_y,s_z)}
=
\begin{bmatrix}
s_x & 0 & 0 & 0 \\
0 & s_y & 0 & 0 \\
0 & 0 & s_z & 0 \\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$
**平移：**
$$
T_{(t_x,t_y,t_z)}
=
\begin{bmatrix}
1 & 0 & 0 & t_x \\
0 & 1 & 0 & t_y \\
0 & 0 & 1 & t_z \\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$
**旋转(俯仰，侧滚，偏航)：**

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\3D旋转.png)
$$
R_{x(\alpha)}=
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & \cos \alpha & -\sin \alpha & 0 \\
0 & \sin \alpha & \cos \alpha & 0 \\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$

$$
R_{y(\alpha)}=
\begin{bmatrix}
\cos \alpha & 0 & \sin \alpha & 0 \\
0 & 1 & 0 & 0 \\
-\sin \alpha & 0 & \cos \alpha & 0 \\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$

$$
R_{z(\alpha)}=
\begin{bmatrix}
\cos \alpha & -\sin \alpha & 0 & 0 \\
\sin \alpha & \cos \alpha & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$

### 罗德里格斯旋转分解公式（Rodrigues` Rotation Formula）

**分解沿过原点任意轴向旋转**
$$
R_{(n,\alpha)}=\cos(\alpha)I+(1-\cos(\alpha))nn^T+\sin(\alpha)\underbrace{
\begin{bmatrix}
0 & -n_z & n_y \\
n_z & 0 & -n_x \\
-n_z & n_x & 0 \\
\end{bmatrix}
}_{N}
$$

## 视图变换（View Transformation）

### 定义相机位置

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\定义相机.png" style="zoom:67%;" />

**相机至少有一下属性：**

- 坐标位置(Position):$ \vec e$
- 视角朝向(Look-at / Gaze direction):$ \hat g$
- 上方向(UP direction):$ \hat t$



**相机变换？物体变换！**

- 只要相机和物体相对位置不变，变换就对成像无意义
- ==相机默认处于原点，向-z方向，以y方向为上方向==

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\默认相机位.png)

### 相机变换

**存在相机处于坐标位置(Position):$ \vec e$，视角朝向(Look-at / Gaze direction):$ \hat g$，上方向(UP direction):$ \hat t$**

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\假设相机.png)

**将其移动到默认位置需要：**

- 拆解变换$ M_{view}=R_{view}T_{view}$

- 移动$ \vec e$去往原点
  $$
  T_{view}=
  \begin{bmatrix}
  1 & 0 & 0 & -x_e \\
  0 & 1 & 0 & -y_e \\
  0 & 0 & 1 & -z_e \\
  0 & 0 & 0 & 1\\
  \end{bmatrix}
  $$
  
- 将$ \hat g$转向-z方向

$$
R_{z(\alpha)}=
\begin{bmatrix}
x_{\hat g \times \hat t} & y_{\hat g \times \hat t} & z_{\hat g \times \hat t} & 0 \\
x_t & y_t & z_t & 0 \\
x_{-g} & y_{-g} & z_{-g} & 0 \\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$


$$
\boxed{
PS:可通过逆矩阵简单求得，因为旋转矩阵是正交矩阵，所以可以通过转置矩阵获得\\
R_{view}^{-1}=

\begin{bmatrix}
x_{\hat g \times \hat t} & x_t & x_{-g} & 0 \\
y_{\hat g \times \hat t} & y_t & y_{-g} & 0 \\
z_{\hat g \times \hat t} & z_t & z_{-g} & 0 \\
0 & 0 & 0 & 1\\
\end{bmatrix} \
\stackrel{WHY?}{\Rightarrow } \
R_{z(\alpha)}=
\begin{bmatrix}
x_{\hat g \times \hat t} & y_{\hat g \times \hat t} & z_{\hat g \times \hat t} & 0 \\
x_t & y_t & z_t & 0 \\
x_{-g} & y_{-g} & z_{-g} & 0 \\
0 & 0 & 0 & 1\\
\end{bmatrix}
}
$$


- 将$ \hat t$转向y方向

### 正交投影变换（Orthographic Projection）

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\正交投影.png)

**对于正交投影，远近关系只决定遮挡，而不会影响投影后的图像大小，为了进行这样的变换需要：**

- 建立立方体
  - 定义其左表面n，右表面b，上表面高度t，下表面高度r，前表面f，后表面n
  - 即[l,r]✖[b,t]✖[f,n]
  - 注意：因为是左手系，摄像机朝向-z，所以在数值上f<n,即远<近，在逻辑上和高大低小，右大左小很不一样

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\建立立方体.png)

- 将这个立方体变换成为位于原点的[-1,1]✖[-1,1]✖[-1,1]标准立方体

  - 首先进行位移
  - 然后进行缩放

  

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\变换成为标准立方体.png)
$$
W_{ortho}=
\begin{bmatrix}
\frac{2}{r-l} & 0 & 0 & 0 \\
0 & \frac{2}{t-b} & 0 & 0 \\
0 & 0 & \frac{2}{n-f} & 0 \\
0 & 0 & 0 & 1\\
\end{bmatrix}
\begin{bmatrix}
1 & 0 & 0 & -\frac{r+l}{2} \\
0 & 1 & 0 & -\frac{t+b}{2} \\
0 & 0 & 1 & -\frac{n+f}{2} \\
0 & 0 & 0 & 1\\
\end{bmatrix}
$$

### 透射投影（Perspective Projestion）

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\透射投影.png" style="zoom: 80%;" />

**透射投影符合自然规律，近大远小，可以看成是对空间范围物体进行一次挤压，然后对结果正交投影：**

- 对视锥进行挤压

  - 挤压后图形x，y会通过图中相似三角形的方法变成和近点一样<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\透射挤压原理.png" style="zoom:80%;" />

  - 于是我们可以推出：

    
    $$
    \begin{bmatrix}
    x\\y\\z\\1
    \end{bmatrix}
    \Rightarrow
    \begin{bmatrix}
    nx/z\\ny/z\\Unknow\\1
    \end{bmatrix}
    \stackrel{mult.\\by \ z}{== }
    \begin{bmatrix}
    nx\\ny\\Still\ Unknow\\z
    \end{bmatrix}
    $$

  - 于是我们可以得出变换前和变换后矩阵部分的情况

    
    $$
    M_{persp\rightarrow otho}^{4\times 4}
    \begin{bmatrix}
    x\\y\\z\\1
    \end{bmatrix}
    =
    \begin{bmatrix}
    nx\\ny\\Still\ Unknow\\z
    \end{bmatrix}
    $$

  - 推断出变换矩阵

    
    $$
    M_{persp\rightarrow otho}^{4\times 4}=
    \begin{bmatrix}
    n & 0 & 0 & 0 \\
    0 & 0 & 0 & 0 \\
    ? & ? & ? & ? \\
    0 & 0 & 1 & 0\\
    \end{bmatrix}
    $$

  - 通过观察可知：

    - 任何近平面点不会发生任何变变化
    - 远平面的z也不会进行变化

  - 于是我们可以得出变换前和变换后矩阵的情况

    - 对于矩阵$ \begin{bmatrix}nx\\ny\\n^2\\1\end{bmatrix}$实质上和矩阵$ \begin{bmatrix}x\\y\\n\\1\end{bmatrix}$一样

    
    $$
    M_{persp\rightarrow otho}^{4\times 4}
    \begin{bmatrix}
    x\\y\\z\\1
    \end{bmatrix}
    =
    \begin{bmatrix}
    nx\\ny\\Still\ Unknow\\z
    \end{bmatrix}
    \stackrel{replace\\z\ with\ n}{== }
    \begin{bmatrix}
    x\\y\\n\\1
    \end{bmatrix}
    \rightarrow
    \begin{bmatrix}
    x\\y\\n\\1
    \end{bmatrix}
    ==
    \begin{bmatrix}
    nx\\ny\\n^2\\n
    \end{bmatrix}
    $$

  - 简化为：

    
    $$
    \begin{bmatrix}
    0 & 0 & A & B
    \end{bmatrix}
    \begin{bmatrix}
    x\\y\\n\\1
    \end{bmatrix}
    =n^2
    $$

  - 为了得出A，B我们来查看特殊情况：

    - 已知远平面的点z坐标依旧不变

    - 且远平面的中心点(0,0,f)的x，y坐标也不变化

      
      $$
      \begin{bmatrix}
      0\\0\\f\\1
      \end{bmatrix}
      \Rightarrow
      \begin{bmatrix}
      0\\0\\f\\1
      \end{bmatrix}
      ==
      \begin{bmatrix}
      x\\y\\f^2\\f
      \end{bmatrix}
      $$

    - 得出方程式：

      
      $$
      \begin{cases}
      An+B=n^2\\
      Af+B=f^2 \\
      \end{cases}
      \Rightarrow
      \begin{cases}
      A=n+f\\
      B=-nf\\
      \end{cases}
      $$

  - 代入A，B就可以得到结果

    
    $$
    M_{persp\rightarrow otho}^{4\times 4}=
    \begin{bmatrix}
    n & 0 & 0 & 0 \\
    0 & 0 & 0 & 0 \\
    0 & 0 & n+f & -nf \\
    0 & 0 & 1 & 0\\
    \end{bmatrix}
    $$

- 然后将变换完成的立方体进行正交投影

## 三角形的光栅化

### 定义视锥

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\视锥的定义.png)

- **长宽比：**长度除宽度
- **垂直/平行可视角度：**锥底上与上方向相互垂直/平行的线在锥面上投影出的角度

**通过这些我们可以变换投影矩阵的相似三角形:**

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\定义视锥对投影矩阵的影响.png)
$$
\tan{\frac {fovY}2}=\frac Y{|n|}
$$

$$
aspect=\frac rt
$$

### 什么是光栅化？

**现在我们拥有一个包含所有物体数据的([1,-1],[1,-1],[1,-1])立方体和一块被我们定义好的屏幕，屏幕上存在大量将会构成图像的像素，将图形转化为像素，这一步就是光栅化**

**对本课抽象概念的像素有以下定义：**

- 像素为平面正方形
- 像素有R，G，B三个属性，分别掌管一种颜色

**对本节课的屏幕空间有以下定义方案：**

![](C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\屏幕空间定义.png)

- 像素坐标都写为(x,y)形式，每个像素单位为1
  - Eg.蓝色像素坐标为(2,1)
- 所有像素存在于([0,width-1],[0,height-1])空间内
- 像素中心位于(x+0.5,y+0.5)范围内
- 屏幕空间位于([0,width],[0,height])范围内

### 如何光栅化？

- 视口变换（Ciewport Transformation）

  - 先不管z

  - 将立方体x，y变形为width，height

  - 立方体左下角变为屏幕左下角(0,0)

  - 变形方程为

    
    $$
    M_{viewport}=
    \begin{bmatrix}
    \frac{width}2 & 0 & 0 & \frac{width}2 \\
    0 & \frac{height}2 & 0 & \frac{height}2 \\
    0 & 0 & 1 & 0 \\
    0 & 0 & 0 & 1\\
    \end{bmatrix}
    $$

- 三角形（Trianger）的优势

  - 三角形是最基础的多边形
  - 三角形必定是平面图形
  - 三角形的内外明确，不存在凹形挖孔情况
  - 可以利用重心坐标为三角形插值

### 采样式光栅化（Sampling）

**简单理解来说，采样就是对给定输入值求输出的过程，我们这里的采样指利用屏幕中心对图形采样**

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\采样.png" style="zoom:50%;" />

**我们只需要判断屏幕中心是否位于某个三角形内即可,定义函数：**
$$
inside(t,x,y)\begin{cases}
1\ \ point(x,y)in \ triangle \ t\\
0\ \ otherwise\\
\end{cases}
$$

```c
for (int x=0 ; x<xmax ; ++x)
    for(int y=0 ; y<ymax ; ++y)
        image[x][y] = inside(tri
    					x+0.5,
                        y+0.5);
```

**那么如何实现inside()函数？**

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\向量解决三角形包含问题.png" style="zoom:50%;" />

在上图里我们通过将Q与P~1~，P~2~相互叉乘的方法解决了判断Q位于P~1~，P~2~的哪一侧的问题，同样，我们只要将这个方法重复3次就可以判断Q是否被P~1~，P~2~，P~3~包围。

**如果点位于三角形边界上怎么办？**

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\采样边界问题.png" style="zoom:50%;" />

**一般来说有两种解决方法：**

- 不做处理（忽略这一个像素）
- 特殊处理（两个三角形都是，或者是最后遍历的那个三角形，或者……）
- OpenGL和DX的解决方法是上边和左边算，下边和右边不算（较为复杂）

**显然，很多情况下，我们不需要遍历所有的屏幕空间来查看一个三角形，为三角形找一个包裹它的较小的矩形是一个不错的想法**

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\优化遍历对象集.png" style="zoom:80%;" />

- 这个被大概选择的区域叫三角形的轴向包围和
- 获得这个区域只需要分别获得三个点中最小的x，最大的x，最小的y，最大的y即可

**有时候某些窄长倾斜的三角形会让包围和也难以解决，这个时候我们可以考虑仅遍历这个三角形范围内每行来解决问题**

<img src="C:\Users\Nerd\OneDrive\学习\Learning_notes\计算机图形学入门\image\仅遍历三角形.png" style="zoom:80%;" />